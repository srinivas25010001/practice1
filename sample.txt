
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nodeapp-deployment
  labels:
    app: nodeapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nodeapp
  template:
    metadata:
      labels:
        app: nodeapp
    spec:
      containers:
      - name: nodeserver
        image: thetips4you/nodeapp:latest
        ports:
        - containerPort: 3000


---

apiVersion: v1
kind: Service
metadata:
  name: nodeapp-service
spec:
  selector:
    app: nodeapp
  type: LoadBalancer
  ports:
  - protocol: TCP
    port: 5000
    targetPort: 3000
    nodePort: 31110


FROM httpd:2.4 AS apache

RUN apt-get update && apt-get install -y curl && \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean

WORKDIR /usr/src/app

COPY package.json ./
RUN npm install --only=production && npm cache clean --force

COPY . .

EXPOSE 80

RUN apt-get update && apt-get install -y apache2-utils && \
    a2enmod proxy proxy_http rewrite

COPY httpd.conf /usr/local/apache2/conf/httpd.conf

CMD ["sh", "-c", "node /usr/src/app/server.js & httpd -D FOREGROUND"]



FROM node:18.17.0-bullseye-slim AS node
ENV ENV=production
WORKDIR /usr/src/app
COPY package.json ./
RUN npm install && npm ci --only=production --omit=dev && npm cache clean --force
COPY . .
EXPOSE 80
RUN chmod a+x /usr/src/app/startup.sh
ENTRYPOINT ["/usr/src/app/startup.sh"]

//httpd.conf 

ServerName localhost

# Enable Reverse Proxy
ProxyRequests Off
ProxyPreserveHost On

# Node.js App Proxy
<VirtualHost *:80>
    ProxyPass "/" "http://localhost:3000/"
    ProxyPassReverse "/" "http://localhost:3000/"
    
    ErrorLog /usr/local/apache2/logs/error.log
    CustomLog /usr/local/apache2/logs/access.log combined
</VirtualHost>
